{% extends "base.html" %}

{% block title %}Available Slots - {{ CLUB_NAME }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-calendar3"></i> Available Interview Slots</h1>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('candidate.dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item active">Available Slots</li>
        </ol>
    </nav>
</div>

{% if existing_booking %}
<div class="alert alert-warning">
    <i class="bi bi-exclamation-triangle"></i>
    <strong>Note:</strong> You have already booked a slot. Cancel it from your dashboard if you want to select a different time.
</div>
{% endif %}

<!-- Date Filter -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="date" class="form-label"><i class="bi bi-funnel"></i> Filter by Date</label>
                <input type="date" class="form-control" id="date" name="date" value="{{ date_filter }}">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> Filter
                </button>
            </div>
            <div class="col-md-2">
                <a href="{{ url_for('candidate.view_slots') }}" class="btn btn-light w-100">
                    <i class="bi bi-x-lg"></i> Clear
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Slots by Date -->
{% if slots_by_date %}
    {% for date, slots in slots_by_date.items() %}
    <div class="card mb-4 slide-in">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-calendar-event"></i> {{ date.strftime('%A, %B %d, %Y') }}</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for slot in slots %}
                <div class="col-md-4 mb-3" data-slot-id="{{ slot.id }}">
                    <div class="slot-card {% if not slot.is_available %}full{% endif %}">
                        <div class="slot-date">
                            <i class="bi bi-clock-fill"></i> 
                            {{ slot.start_time.strftime('%I:%M %p') }} - {{ slot.end_time.strftime('%I:%M %p') }}
                        </div>
                        <div class="slot-spots">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">Capacity: {{ slot.capacity }}</small><br>
                                    {% if slot.is_available %}
                                    <span class="badge bg-success">{{ slot.available_spots }} spots available</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Fully Booked</span>
                                    {% endif %}
                                </div>
                                
                                {% if slot.is_available and not existing_booking %}
                                <form method="POST" action="{{ url_for('candidate.book_slot', slot_id=slot.id) }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-primary"
                                            onclick="return confirm('Confirm booking for {{ date.strftime('%b %d') }} at {{ slot.start_time.strftime('%I:%M %p') }}?');">
                                        <i class="bi bi-check-circle"></i> Book
                                    </button>
                                </form>
                                {% elif not slot.is_available %}
                                <button class="btn btn-secondary" disabled>
                                    <i class="bi bi-x-circle"></i> Full
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
<div class="card">
    <div class="card-body">
        <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <h5>No Available Slots</h5>
            <p>No available interview slots found. Please check back later or contact support.</p>
        </div>
    </div>
</div>
{% endif %}

<div class="mt-4">
    <a href="{{ url_for('candidate.dashboard') }}" class="btn btn-light">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
</div>
{% endblock %}

{% block extra_js %}
<style>
/* Toast notifications */
.slot-toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    color: white;
    font-weight: 500;
    z-index: 9999;
    animation: slideIn 0.3s ease-out;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    max-width: 400px;
}
.slot-toast.success { background: linear-gradient(135deg, #16a34a, #15803d); }
.slot-toast.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
.slot-toast.error { background: linear-gradient(135deg, #dc2626, #b91c1c); }
.slot-toast.info { background: linear-gradient(135deg, #0ea5e9, #0284c7); }
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
/* Loading spinner */
.btn-loading {
    position: relative;
    pointer-events: none;
    color: transparent !important;
}
.btn-loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin: -8px 0 0 -8px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
/* Slot update animation */
.slot-updating {
    animation: pulse 0.5s ease-in-out;
}
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}
</style>

<script>
let bookingInProgress = false;
let existingBooking = {{ 'true' if existing_booking else 'false' }};

// Show toast notification
function showToast(message, type = 'info', duration = 4000) {
    const toast = document.createElement('div');
    toast.className = `slot-toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

// CSRF token helper
function getCsrfToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta) return meta.getAttribute('content');
    const input = document.querySelector('input[name="csrf_token"]');
    return input ? input.value : '';
}

// Book slot via AJAX
async function bookSlot(slotId, button) {
    if (bookingInProgress || existingBooking) return;
    
    if (!confirm('Confirm booking for this slot?')) return;
    
    bookingInProgress = true;
    
    // Disable all book buttons
    document.querySelectorAll('button[data-book-slot]').forEach(btn => {
        btn.disabled = true;
    });
    
    // Show loading on clicked button
    button.classList.add('btn-loading');
    
    try {
        const response = await fetch(`/api/slots/${slotId}/book`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Interview slot booked successfully! Redirecting...', 'success');
            existingBooking = true;
            // Redirect after a short delay
            setTimeout(() => {
                window.location.href = '{{ url_for("candidate.dashboard") }}';
            }, 1500);
        } else {
            showToast(data.message || 'Booking failed', 'error');
            // If slot became full, update the UI
            if (data.error_type === 'slot_full' || data.error_type === 'slot_closed') {
                updateSlotUI(slotId, { is_available: false, is_full: true, available_spots: 0 });
            }
            bookingInProgress = false;
            // Re-enable buttons
            document.querySelectorAll('button[data-book-slot]').forEach(btn => {
                const slotEl = btn.closest('[data-slot-id]');
                if (slotEl && !slotEl.querySelector('.slot-card.full')) {
                    btn.disabled = false;
                }
            });
        }
    } catch (error) {
        console.error('Booking error:', error);
        showToast('Network error. Please try again.', 'error');
        bookingInProgress = false;
        document.querySelectorAll('button[data-book-slot]').forEach(btn => btn.disabled = false);
    }
    
    button.classList.remove('btn-loading');
}

// Update slot UI when status changes
function updateSlotUI(slotId, slotData) {
    const slotElement = document.querySelector(`[data-slot-id="${slotId}"]`);
    if (!slotElement) return;
    
    slotElement.classList.add('slot-updating');
    
    const slotCard = slotElement.querySelector('.slot-card');
    const badge = slotElement.querySelector('.badge');
    const buttonContainer = slotElement.querySelector('.slot-spots');
    
    if (slotData.is_available && !existingBooking) {
        slotCard.classList.remove('full');
        badge.className = 'badge bg-success';
        badge.textContent = `${slotData.available_spots} spots available`;
        
        // Restore book button if missing
        if (!buttonContainer.querySelector('button[data-book-slot]')) {
            const form = document.createElement('form');
            form.innerHTML = `
                <input type="hidden" name="csrf_token" value="${getCsrfToken()}">
                <button type="button" class="btn btn-primary" data-book-slot="${slotId}"
                        onclick="bookSlot(${slotId}, this)">
                    <i class="bi bi-check-circle"></i> Book
                </button>
            `;
            buttonContainer.appendChild(form);
        }
    } else {
        slotCard.classList.add('full');
        badge.className = 'badge bg-secondary';
        badge.textContent = 'Fully Booked';
        
        // Replace with disabled button
        const existingBtn = buttonContainer.querySelector('button[data-book-slot]');
        if (existingBtn) {
            existingBtn.outerHTML = `<button class="btn btn-secondary" disabled>
                <i class="bi bi-x-circle"></i> Full
            </button>`;
        }
    }
    
    setTimeout(() => slotElement.classList.remove('slot-updating'), 500);
}

// Refresh slot availability every 5 seconds
let lastSlotData = {};

async function refreshSlots() {
    if (bookingInProgress) return;
    
    try {
        const response = await fetch('/api/slots');
        const data = await response.json();
        
        if (data.success) {
            let changedSlots = 0;
            
            data.slots.forEach(slot => {
                const lastData = lastSlotData[slot.id];
                
                // Check if slot status changed
                if (lastData && 
                    (lastData.available_spots !== slot.available_spots || 
                     lastData.is_available !== slot.is_available)) {
                    changedSlots++;
                }
                
                updateSlotUI(slot.id, slot);
                lastSlotData[slot.id] = slot;
            });
            
            // Notify user if slots changed
            if (changedSlots > 0 && Object.keys(lastSlotData).length > data.slots.length) {
                showToast('Slot availability has been updated', 'info', 3000);
            }
        }
    } catch (error) {
        console.error('Error refreshing slots:', error);
    }
}

// Initial load of slot data and start polling
document.addEventListener('DOMContentLoaded', () => {
    // Convert all book forms to AJAX
    document.querySelectorAll('form[action*="book-slot"]').forEach(form => {
        const slotId = form.action.match(/book-slot\/(\d+)/)?.[1];
        if (slotId) {
            const button = form.querySelector('button[type="submit"]');
            if (button) {
                button.type = 'button';
                button.setAttribute('data-book-slot', slotId);
                button.onclick = () => bookSlot(slotId, button);
            }
        }
    });
    
    // Initial slot data fetch
    refreshSlots();
    
    // Poll every 5 seconds for real-time updates
    setInterval(refreshSlots, 5000);
});
</script>
{% endblock %}

